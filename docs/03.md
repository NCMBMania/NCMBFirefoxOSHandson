# 画面の設計と画像アップロード機能を作ってみる

前回まででニフティクラウド mobile backendを軽く触ってみましたので、今回は写真アップロードまで進めてみたいと思います。

## 画面を作る

### スタイルシートのダウンロード

まずアプリっぽい画面を作りますが、スタイルシートの説明などを細かく行っていると時間がかかるのでテンプレートを用意しました。こちらのスタイルシートファイルをダウンロードして、 `stylesheets/style.css` として保存してください。以下のようになります。

![](images/firefoxos-3-camera-4.png)

### JavaScriptファイルのダウンロード

次にJavaScriptライブラリをダウンロードしてください。以下に用意してありますので、すべて `javascripts` フォルダ以下に配置してください。

- zepto.js（jQuery代替。スマートフォン/タブレットに特化した分軽量）
- tappable.js（指定した部分をタップ可能にするためのライブラリ）

ダウンロード&配置後のファイル構成は次のようになります。

![](images/firefoxos-3-camera-3.png)

### HTMLファイルについて

次にHTMLファイルを編集します。index.htmlを以下のように編集します。

```html
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ニフティクラウドmobile backend × FirefoxOSアプリ</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
  </head>
  <body>
    <!-- ヘッダー -->
    <header id="top-toolbar">
      <h1>画像ギャラリー</h1>
    </header>

    <!-- 写真を撮るためのボタン -->
    <div class="no-border-button tappable" style="position : relative">
      写真を撮る
      <form action="">
        <input type="file" id="image-file" name="image" style="position : absolute; left : 0; right : 0; top : 0; bottom : 0; z-index : 20; width: 100%;opacity: 0.0;" />
      </form>
    </div>

    <!-- JavaScriptライブラリの読み込み -->
    <script src="javascripts/ncmb-latest.min.js"></script>
    <script src="javascripts/tappable.js"></script>
    <script src="javascripts/zepto.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>
```

ここまでの変更を行ったらWebIDEの再読込ボタンを押して、アプリをリロードしてみます。以下のように表示されればOKです。

![](images/firefoxos-3-app.png)

### 写真のアップロード処理を作る

では実際の写真アップロード処理を作ってみます。 `app.js` を編集します。全体のコードは次のようになります。

前回作ったデータストアに保存する処理は消してあります。その代わり GalleryController という変数が追加してあります。

```javascript
window.addEventListener("load", function() {
  console.log("Hello World!");
  var application_key = "cd9e16e539b6aa8bf567e90b95aec87472e3d957ec1183b535fa70f1f0067052"; // アプリケーションキー
  var client_key = "3de0306f0a03b8698040820f6cb309141011985af493e863a9504fd813e52c9f"; // クライアントキー
  NCMB.initialize(application_key, client_key);  // 初期化の実行  
  
  var GalleryController = {
    init : function() {
      console.log(GalleryController);
      $('#image-file').change(function() {
        GalleryController.upload();
      });
    },
    
    // 画像をアップロードする
    upload : function() {
      console.log("アップロード処理開始");
      var fileInput = $("#image-file")[0];
      if (fileInput.files.length > 0) {
        var file = fileInput.files[0];            
        if (!(/\.(png|jpg|jpeg|gif)$/i).test(file.name)) {
          return true;
        }
        
        // ファイルリーダーオブジェクト
        var reader = new FileReader();
        // 縮小画像を当てはめる画像オブジェクト
        var image = new Image();
        
        // ファイルリーダーで読み込んだら以下の処理を実行
        reader.onloadend = function() {
          
          // 画像オブジェクトに読み込んだら以下の処理を実行
          image.onload = function() {
            // 画像を加工するためのCanvasオブジェクト生成
            var canvas = $("<canvas />")[0];
            var max  = 200; // 加工する画像の幅
            ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, 0, 0);
            if (image.width < image.height) {
              // 縦長の場合
              canvas.height = max; // 高さ固定
              canvas.width  = max * image.width / image.height; // 加工後の画像の高さ
            }else{
              canvas.width  = max; // 幅固定
              canvas.height = max * image.height / image.width; // 加工後の画像の高さ
            }
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height); // 縮小処理
            
            // toDataURLで取り出せるデータはBase64なのでBlobに変換します。
            var data = toBlob(canvas.toDataURL());
            
            // NCMB ファイルストレージの生成
            var ncmbFile = new NCMB.File(Date.now() + file.name, data, "image/png");
            
            // 保存処理
            ncmbFile.save().then(function() {
              // アップロード成功
              console.log("アップロードしました！");
            }, function(error) {
              // アップロード失敗
              console.log("アップロード失敗しました", error);
            });
          };
          
          // ファイルリーダーの結果を画像オブジェクトに適用
          image.src = reader.result;
        };
        
        // ファイルリーダーの読み込み処理開始
        reader.readAsDataURL(file);        
      }
    }
  };
  GalleryController.init();
});

function toBlob(base64) {
  var bin = atob(base64.replace(/^.*,/, ''));
  var buffer = new Uint8Array(bin.length);
  for (var i = 0; i < bin.length; i++) {
    buffer[i] = bin.charCodeAt(i);
  }
  // Blobを作成
  try{
    var blob = new Blob([buffer.buffer], {
      type: 'image/png'
    });
  }catch (e){
    return false;
  }
  return blob;
}
```

GalleryController.init()を最後に実行しています。これはファイルアップロードで写真が選ばれたら発火するイベントです。

```
    init : function() {
      $('#image-file').change(function() {
        GalleryController.upload();
      });
    },
```

実際のアップロード処理は次のようになっています。

```
    // 画像をアップロードする
    upload : function() {
      console.log("アップロード処理開始");
      var fileInput = $("#image-file")[0];
      if (fileInput.files.length > 0) {
        var file = fileInput.files[0];            
        if (!(/\.(png|jpg|jpeg|gif)$/i).test(file.name)) {
          return true;
        }
        
        // ファイルリーダーオブジェクト
        var reader = new FileReader();
        // 縮小画像を当てはめる画像オブジェクト
        var image = new Image();
        
        // ファイルリーダーで読み込んだら以下の処理を実行
        reader.onloadend = function() {
          
          // 画像オブジェクトに読み込んだら以下の処理を実行
          image.onload = function() {
            // 画像を加工するためのCanvasオブジェクト生成
            var canvas = $("<canvas />")[0];
            var max  = 200; // 加工する画像の幅
            ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, 0, 0);
            if (image.width < image.height) {
              // 縦長の場合
              canvas.height = max; // 高さ固定
              canvas.width  = max * image.width / image.height; // 加工後の画像の高さ
            }else{
              canvas.width  = max; // 幅固定
              canvas.height = max * image.height / image.width; // 加工後の画像の高さ
            }
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height); // 縮小処理
            
            // toDataURLで取り出せるデータはBase64なのでBlobに変換します。
            var data = toBlob(canvas.toDataURL());
            
            // NCMB ファイルストレージの生成
            var ncmbFile = new NCMB.File(Date.now() + file.name, data, "image/png");
            
            // 保存処理
            ncmbFile.save().then(function() {
              // アップロード成功
              console.log("アップロードしました！");
            }, function(error) {
              // アップロード失敗
              console.log("アップロード失敗しました", error);
            });
          };
          
          // ファイルリーダーの結果を画像オブジェクトに適用
          image.src = reader.result;
        };
        
        // ファイルリーダーの読み込み処理開始
        reader.readAsDataURL(file);        
      }
    }
```

写真は原寸のままではサイズが大きいので、Canvas/Image/FileReaderを使って縮小処理を行っています。コールバックが多いので分かりづらいですが、簡単に書くと以下のようになります。

```javascript
var reader = new FileReader(); // ファイルリーダーオブジェクト

var image = new Image(); // 縮小画像を当てはめる画像オブジェクト
        
// ファイルリーダーで読み込んだら以下の処理を実行
reader.onloadend = function() {
          
  // 画像オブジェクトに読み込んだら以下の処理を実行
  image.onload = function() {
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height); // 縮小処理
    // toDataURLで取り出せるデータはBase64なのでBlobに変換します。
    var data = toBlob(canvas.toDataURL());
  }
  image.src = reader.result;
};
        
// ファイルリーダーの読み込み処理開始
reader.readAsDataURL(file);
```

また、Canvasで取り出せるのはBase64エンコードされているので、toBlobという独自の関数でBlobデータに変換しています。

そして加工が完了後、NCMB.Fileオブジェクトを作っています。ファイル名は時間を使っています。

```
var ncmbFile = new NCMB.File(Date.now() + file.name, data, "image/png");
```

後はデータストアの時と同じようにsave()を実行してクラウド上に保存しています。こちらもPromiseに対応していますのでthen()メソッドで結果を受け取っています。

## 実行してみる

ではアプリを実機に転送して実行してみましょう。写真を撮るをタップすると画像選択が出ます。

![](images/firefoxos-3-select.png)

カメラを選択して撮影します。

![](images/firefoxos-3-camera.png)

カメラが閉じてファイルアップロード処理が実行されます。次のように **アップロードしました！** と出ればOKです。

![](images/firefoxos-3-camera-1.png)

----

今回はここまでになります。次回はアップロードするだけでなく、撮影した写真を一覧表示してみたいと思います。

